<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muni Metro Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .header .subtitle { color: #888; font-size: 0.9em; }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .status-banner {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: background 0.5s ease;
        }

        .status-banner.green {
            background: linear-gradient(135deg, #208020, #2a9a2a);
        }
        .status-banner.yellow {
            background: linear-gradient(135deg, #a08000, #c0a000);
        }
        .status-banner.red {
            background: linear-gradient(135deg, #a02020, #cc3030);
        }
        .status-banner.loading {
            background: #3a3a5a;
        }

        .status-icon { font-size: 3em; margin-bottom: 10px; }
        .status-text { font-size: 1.4em; font-weight: bold; text-transform: uppercase; }
        .status-desc { margin-top: 8px; opacity: 0.9; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .panel {
            background: #2a2a4a;
            border-radius: 8px;
            padding: 15px;
        }

        .panel h2 {
            font-size: 1em;
            color: #8af;
            margin-bottom: 12px;
            border-bottom: 1px solid #4a4a6a;
            padding-bottom: 8px;
        }

        .panel-content {
            max-height: 250px;
            overflow-y: auto;
        }

        .item {
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .item.delay-red {
            background: #4a2020;
            border-left: 4px solid #ff4444;
        }
        .item.delay-yellow {
            background: #4a4a20;
            border-left: 4px solid #ffcc00;
        }
        .item.delay-bunching {
            background: #4a2040;
            border-left: 4px solid #ff44ff;
        }
        .item.train-high {
            background: #204020;
            border-left: 4px solid #44ff44;
        }
        .item.train-medium {
            background: #404020;
            border-left: 4px solid #ffcc44;
        }
        .item.train-low {
            background: #403020;
            border-left: 4px solid #ff8844;
        }

        .item .label { font-weight: 600; }
        .item .detail { color: #aaa; font-size: 0.85em; margin-top: 2px; }

        .no-data {
            color: #6a6a8a;
            font-style: italic;
            padding: 10px;
        }

        .all-clear {
            color: #6a8a6a;
            padding: 10px;
            text-align: center;
        }

        .metadata {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #1a1a2e;
            border-radius: 6px;
            font-size: 0.8em;
            color: #888;
            margin-top: 20px;
        }

        .metadata-item span { display: block; }
        .metadata-item .label { color: #666; font-size: 0.9em; }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4a4a6a;
            border-top: 2px solid #8af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-note {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 15px;
        }

        .error-banner {
            background: #4a2020;
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Muni Metro Dashboard</h1>
            <p class="subtitle">Real-time subway system status</p>
        </div>

        <div id="app">
            <div class="status-banner loading">
                <div class="status-icon"><span class="loading-spinner"></span></div>
                <div class="status-text">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/status';
        const REFRESH_INTERVAL = 30000;

        const statusConfig = {
            green: { icon: '&#x1F7E2;', text: 'Normal Operation', class: 'green' },
            yellow: { icon: '&#x1F7E1;', text: 'Delays Detected', class: 'yellow' },
            red: { icon: '&#x1F534;', text: 'Not Operating', class: 'red' }
        };

        async function fetchStatus() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (response.ok) {
                    renderDashboard(data);
                } else {
                    renderError(data.error || 'Failed to fetch status');
                }
            } catch (error) {
                renderError('Network error: ' + error.message);
            }
        }

        function renderDashboard(data) {
            const config = statusConfig[data.status] || statusConfig.yellow;
            const detection = data.detection || {};

            const delays = [];

            // Track segments disabled
            if (detection.delays_segments) {
                detection.delays_segments.forEach(d => {
                    delays.push({
                        type: 'segment',
                        html: `<div class="label">Track Disabled</div>
                               <div class="detail">${d.from} â†’ ${d.to} (${d.direction})</div>`,
                        class: 'delay-red'
                    });
                });
            }

            // Platforms in hold
            if (detection.delays_platforms) {
                detection.delays_platforms.forEach(d => {
                    delays.push({
                        type: 'platform',
                        html: `<div class="label">Platform Hold</div>
                               <div class="detail">${d.name} - ${d.direction}</div>`,
                        class: 'delay-yellow'
                    });
                });
            }

            // Train bunching
            if (detection.delays_bunching) {
                detection.delays_bunching.forEach(d => {
                    delays.push({
                        type: 'bunching',
                        html: `<div class="label">Train Bunching</div>
                               <div class="detail">${d.train_count} trains at ${d.station} (${d.direction})</div>`,
                        class: 'delay-bunching'
                    });
                });
            }

            // Build trains list
            const trains = (detection.trains || []).map(t => {
                let confClass = 'train-high';
                let confLabel = '';
                if (t.confidence === 'medium') {
                    confClass = 'train-medium';
                    confLabel = ' [recovered]';
                } else if (t.confidence === 'low') {
                    confClass = 'train-low';
                    confLabel = ' [unread]';
                }
                return {
                    html: `<div class="label">${t.id}${confLabel}</div>
                           <div class="detail">${t.track} track</div>`,
                    class: confClass
                };
            });

            const timestamp = new Date(data.timestamp).toLocaleString();
            const cacheInfo = data.cached ? `Cached (${Math.round(data.cache_age)}s ago)` : 'Live';

            document.getElementById('app').innerHTML = `
                <div class="status-banner ${config.class}">
                    <div class="status-icon">${config.icon}</div>
                    <div class="status-text">${config.text}</div>
                    <div class="status-desc">${data.description}</div>
                </div>

                <div class="grid">
                    <div class="panel">
                        <h2>Delays (${delays.length})</h2>
                        <div class="panel-content">
                            ${delays.length > 0 ?
                                delays.map(d => `<div class="item ${d.class}">${d.html}</div>`).join('') :
                                '<div class="all-clear">&#10003; No delays detected</div>'
                            }
                        </div>
                    </div>

                    <div class="panel">
                        <h2>Trains Detected (${trains.length})</h2>
                        <div class="panel-content">
                            ${trains.length > 0 ?
                                trains.map(t => `<div class="item ${t.class}">${t.html}</div>`).join('') :
                                '<div class="no-data">No trains detected</div>'
                            }
                        </div>
                    </div>
                </div>

                <div class="metadata">
                    <div class="metadata-item">
                        <span class="label">Last Updated</span>
                        <span>${timestamp}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="label">Source</span>
                        <span>${cacheInfo}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="label">Confidence</span>
                        <span>${(data.confidence * 100).toFixed(0)}%</span>
                    </div>
                </div>

                <div class="refresh-note">Auto-refreshes every 30 seconds</div>
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error-banner">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">&#x26A0;</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">Error Loading Status</div>
                    <div style="color: #ff8888;">${message}</div>
                </div>
            `;
        }

        // Initial fetch
        fetchStatus();

        // Auto-refresh
        setInterval(fetchStatus, REFRESH_INTERVAL);
    </script>
</body>
</html>
