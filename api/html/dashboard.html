<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muni Metro Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .header .subtitle { color: #888; font-size: 0.9em; }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .status-banner {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: background 0.5s ease;
        }

        .status-banner.green { background: linear-gradient(135deg, #208020, #2a9a2a); }
        .status-banner.yellow { background: linear-gradient(135deg, #a08000, #c0a000); }
        .status-banner.red { background: linear-gradient(135deg, #a02020, #cc3030); }
        .status-banner.loading { background: #3a3a5a; }

        .status-icon { font-size: 3em; margin-bottom: 10px; }
        .status-text { font-size: 1.4em; font-weight: bold; text-transform: uppercase; }
        .status-desc { margin-top: 8px; opacity: 0.9; }
        .status-best-of-two {
            margin-top: 10px;
            font-size: 0.85em;
            opacity: 0.8;
            background: rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 4px;
            display: inline-block;
        }

        .image-container {
            background: #2a2a4a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        .image-container h2 {
            font-size: 1em;
            color: #8af;
            margin-bottom: 12px;
        }
        .image-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 4px;
        }
        .image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }
        .image-wrapper svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .panel {
            background: #2a2a4a;
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #3a3a5a;
            cursor: pointer;
            user-select: none;
        }
        .panel-header:hover { background: #4a4a6a; }
        .panel-header h2 {
            font-size: 0.95em;
            color: #8af;
            margin: 0;
        }
        .panel-header .toggle {
            color: #888;
            font-size: 0.9em;
            transition: transform 0.2s;
        }
        .panel-header.collapsed .toggle { transform: rotate(-90deg); }

        .panel-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 15px;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        .panel-content.collapsed {
            max-height: 0;
            padding: 0 15px;
            overflow: hidden;
        }

        .item {
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .item.delay-red { background: #4a2020; border-left: 4px solid #ff4444; }
        .item.delay-yellow { background: #4a4a20; border-left: 4px solid #ffcc00; }
        .item.delay-bunching { background: #4a2040; border-left: 4px solid #ff44ff; }
        .item.train-high { background: #204020; border-left: 4px solid #44ff44; }
        .item.train-medium { background: #404020; border-left: 4px solid #ffcc44; }
        .item.train-low { background: #403020; border-left: 4px solid #ff8844; }
        .item.platform-blue { background: #202040; border-left: 4px solid #4488ff; }
        .item.platform-yellow { background: #4a4a20; border-left: 4px solid #ffcc00; }
        .item.platform-unknown { background: #303030; border-left: 4px solid #666; }

        .item .label { font-weight: 600; }
        .item .detail { color: #aaa; font-size: 0.85em; margin-top: 2px; }

        .no-data { color: #6a6a8a; font-style: italic; padding: 10px; }
        .all-clear { color: #6a8a6a; padding: 10px; text-align: center; }

        .metadata {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            padding: 12px;
            background: #2a2a4a;
            border-radius: 6px;
            font-size: 0.8em;
            color: #888;
            margin-top: 20px;
            gap: 10px;
        }
        .metadata-item span { display: block; }
        .metadata-item .label { color: #666; font-size: 0.9em; }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4a4a6a;
            border-top: 2px solid #8af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-note {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-top: 15px;
        }

        .error-banner {
            background: #4a2020;
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Muni Metro Dashboard</h1>
            <p class="subtitle">Real-time subway system status</p>
        </div>

        <div id="app">
            <div class="status-banner loading">
                <div class="status-icon"><span class="loading-spinner"></span></div>
                <div class="status-text">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/status';
        const IMAGE_URL = '/latest-image';
        const REFRESH_INTERVAL = 30000;

        const statusConfig = {
            green: { icon: '&#x1F7E2;', text: 'Normal Operation', class: 'green' },
            yellow: { icon: '&#x1F7E1;', text: 'Delays Detected', class: 'yellow' },
            red: { icon: '&#x1F534;', text: 'Not Operating', class: 'red' }
        };

        // Station names for display
        const stationNames = {
            'WE': 'West Portal', 'FH': 'Forest Hill', 'CA': 'Castro', 'CH': 'Church',
            'VN': 'Van Ness', 'CC': 'Civic Center', 'PO': 'Powell', 'MO': 'Montgomery',
            'EM': 'Embarcadero', 'CT': 'Chinatown', 'US': 'Union Square', 'YB': 'Yerba Buena'
        };

        let currentImageTimestamp = null;

        async function fetchStatus() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (response.ok) {
                    renderDashboard(data);
                } else {
                    renderError(data.error || 'Failed to fetch status');
                }
            } catch (error) {
                renderError('Network error: ' + error.message);
            }
        }

        function togglePanel(panelId) {
            const header = document.querySelector(`#${panelId} .panel-header`);
            const content = document.querySelector(`#${panelId} .panel-content`);
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        }

        function renderDashboard(data) {
            const config = statusConfig[data.status] || statusConfig.yellow;
            const detection = data.detection || {};

            // Build delays list
            const delays = [];
            if (detection.delays_segments) {
                detection.delays_segments.forEach(d => {
                    delays.push({
                        html: `<div class="label">Track Disabled</div>
                               <div class="detail">${d.from} -> ${d.to} (${d.direction})</div>`,
                        class: 'delay-red'
                    });
                });
            }
            if (detection.delays_platforms) {
                detection.delays_platforms.forEach(d => {
                    delays.push({
                        html: `<div class="label">Platform Hold</div>
                               <div class="detail">${d.name} - ${d.direction}</div>`,
                        class: 'delay-yellow'
                    });
                });
            }
            if (detection.delays_bunching) {
                detection.delays_bunching.forEach(d => {
                    delays.push({
                        html: `<div class="label">Train Bunching</div>
                               <div class="detail">${d.train_count} trains at ${stationNames[d.station] || d.station} (${d.direction})</div>`,
                        class: 'delay-bunching'
                    });
                });
            }

            // Build trains list
            const trains = (detection.trains || []).map(t => {
                let confClass = 'train-high';
                let confLabel = '';
                if (t.confidence === 'medium') {
                    confClass = 'train-medium';
                    confLabel = ' [recovered]';
                } else if (t.confidence === 'low') {
                    confClass = 'train-low';
                    confLabel = ' [unread]';
                }
                return {
                    html: `<div class="label">${t.id}${confLabel}</div>
                           <div class="detail">${t.track} track</div>`,
                    class: confClass
                };
            });

            // Build stations/platforms list
            const platforms = (detection.stations || []).map(s => {
                const upperColor = s.upper_color || 'unknown';
                const lowerColor = s.lower_color || 'unknown';
                const upperClass = upperColor === 'yellow' ? 'platform-yellow' :
                                  upperColor === 'blue' ? 'platform-blue' : 'platform-unknown';
                const lowerClass = lowerColor === 'yellow' ? 'platform-yellow' :
                                  lowerColor === 'blue' ? 'platform-blue' : 'platform-unknown';
                return {
                    name: s.name,
                    upper: { color: upperColor, class: upperClass },
                    lower: { color: lowerColor, class: lowerClass }
                };
            });

            const timestamp = new Date(data.timestamp).toLocaleString();
            const cacheInfo = data.cached ? `Cached (${Math.round(data.cache_age)}s ago)` : 'Live';

            // Best of two info
            let bestOfTwoHtml = '';
            if (data.is_best_of_two && data.status_history && data.status_history.length > 1) {
                const h = data.status_history;
                bestOfTwoHtml = `<div class="status-best-of-two">
                    Best of 2: Current ${h[0].status}, Previous ${h[1].status}
                </div>`;
            }

            // Image timestamp for cache busting
            const imageUrl = IMAGE_URL + '?t=' + Date.now();

            document.getElementById('app').innerHTML = `
                <div class="status-banner ${config.class}">
                    <div class="status-icon">${config.icon}</div>
                    <div class="status-text">${config.text}</div>
                    <div class="status-desc">${data.description}</div>
                    ${bestOfTwoHtml}
                </div>

                <div class="image-container">
                    <h2>Live Status Image</h2>
                    <div class="image-wrapper" id="imageWrapper">
                        <img src="${imageUrl}" alt="Muni Metro Status" id="statusImage" onload="renderOverlay()">
                    </div>
                </div>

                <div class="grid">
                    <div class="panel" id="delaysPanel">
                        <div class="panel-header" onclick="togglePanel('delaysPanel')">
                            <h2>Delays (${delays.length})</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="panel-content">
                            ${delays.length > 0 ?
                                delays.map(d => `<div class="item ${d.class}">${d.html}</div>`).join('') :
                                '<div class="all-clear">&#10003; No delays detected</div>'
                            }
                        </div>
                    </div>

                    <div class="panel" id="trainsPanel">
                        <div class="panel-header collapsed" onclick="togglePanel('trainsPanel')">
                            <h2>Trains Detected (${trains.length})</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="panel-content collapsed">
                            ${trains.length > 0 ?
                                trains.map(t => `<div class="item ${t.class}">${t.html}</div>`).join('') :
                                '<div class="no-data">No trains detected</div>'
                            }
                        </div>
                    </div>

                    <div class="panel" id="platformsPanel">
                        <div class="panel-header collapsed" onclick="togglePanel('platformsPanel')">
                            <h2>Platform Status (${platforms.length} stations)</h2>
                            <span class="toggle">&#9660;</span>
                        </div>
                        <div class="panel-content collapsed">
                            ${platforms.length > 0 ?
                                platforms.map(p => `
                                    <div class="item ${p.upper.color === 'yellow' || p.lower.color === 'yellow' ? 'platform-yellow' : 'platform-blue'}">
                                        <div class="label">${p.name}</div>
                                        <div class="detail">Upper: ${p.upper.color} | Lower: ${p.lower.color}</div>
                                    </div>
                                `).join('') :
                                '<div class="no-data">No platform data</div>'
                            }
                        </div>
                    </div>
                </div>

                <div class="metadata">
                    <div class="metadata-item">
                        <span class="label">Last Updated</span>
                        <span>${timestamp}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="label">Source</span>
                        <span>${cacheInfo}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="label">Detection</span>
                        <span>OpenCV</span>
                    </div>
                </div>

                <div class="refresh-note">Auto-refreshes every 30 seconds</div>
            `;

            // Store detection data for overlay rendering
            window.currentDetection = detection;
        }

        function renderOverlay() {
            const img = document.getElementById('statusImage');
            const wrapper = document.getElementById('imageWrapper');
            const detection = window.currentDetection || {};

            if (!img || !wrapper || !detection.stations) return;

            // Get image dimensions
            const imgWidth = detection.image_dimensions?.width || 1860;
            const imgHeight = detection.image_dimensions?.height || 800;

            // Create SVG overlay
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', `0 0 ${imgWidth} ${imgHeight}`);
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

            // Draw station indicators
            detection.stations.forEach(s => {
                // Upper platform indicator
                const upperColor = s.upper_color === 'yellow' ? '#ffcc00' :
                                  s.upper_color === 'blue' ? '#4488ff' : '#666';
                const upperCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                upperCircle.setAttribute('cx', s.x);
                upperCircle.setAttribute('cy', s.upper_y);
                upperCircle.setAttribute('r', '12');
                upperCircle.setAttribute('fill', upperColor);
                upperCircle.setAttribute('stroke', '#fff');
                upperCircle.setAttribute('stroke-width', '2');
                upperCircle.setAttribute('opacity', '0.8');
                svg.appendChild(upperCircle);

                // Lower platform indicator
                const lowerColor = s.lower_color === 'yellow' ? '#ffcc00' :
                                  s.lower_color === 'blue' ? '#4488ff' : '#666';
                const lowerCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                lowerCircle.setAttribute('cx', s.x);
                lowerCircle.setAttribute('cy', s.lower_y);
                lowerCircle.setAttribute('r', '12');
                lowerCircle.setAttribute('fill', lowerColor);
                lowerCircle.setAttribute('stroke', '#fff');
                lowerCircle.setAttribute('stroke-width', '2');
                lowerCircle.setAttribute('opacity', '0.8');
                svg.appendChild(lowerCircle);

                // Station label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', s.x);
                label.setAttribute('y', (s.upper_y + s.lower_y) / 2);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('dominant-baseline', 'middle');
                label.setAttribute('fill', '#fff');
                label.setAttribute('font-size', '14');
                label.setAttribute('font-weight', 'bold');
                label.setAttribute('stroke', '#000');
                label.setAttribute('stroke-width', '3');
                label.setAttribute('paint-order', 'stroke');
                label.textContent = s.code;
                svg.appendChild(label);
            });

            // Draw train indicators
            (detection.trains || []).forEach(t => {
                const trainMarker = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                trainMarker.setAttribute('x', t.x - 8);
                trainMarker.setAttribute('y', t.y - 6);
                trainMarker.setAttribute('width', '16');
                trainMarker.setAttribute('height', '12');
                trainMarker.setAttribute('fill', t.confidence === 'high' ? '#44ff44' :
                                                t.confidence === 'medium' ? '#ffcc44' : '#ff8844');
                trainMarker.setAttribute('stroke', '#fff');
                trainMarker.setAttribute('stroke-width', '1');
                trainMarker.setAttribute('rx', '2');
                trainMarker.setAttribute('opacity', '0.9');
                svg.appendChild(trainMarker);
            });

            // Remove existing SVG if any
            const existingSvg = wrapper.querySelector('svg');
            if (existingSvg) existingSvg.remove();

            wrapper.appendChild(svg);
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error-banner">
                    <div style="font-size: 1.5em; margin-bottom: 10px;">&#x26A0;</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">Error Loading Status</div>
                    <div style="color: #ff8888;">${message}</div>
                </div>
            `;
        }

        // Initial fetch
        fetchStatus();

        // Auto-refresh
        setInterval(fetchStatus, REFRESH_INTERVAL);
    </script>
</body>
</html>
